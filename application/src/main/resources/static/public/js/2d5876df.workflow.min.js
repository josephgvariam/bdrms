!function(){var e,s,n={showInfoModal:function(e,t,o){var i=$("#infoModal");i.find(".modal-title").text(e),i.find(".modal-body").html("<p>"+t+"</p>"),o&&i.on("hidden.bs.modal",o),i.modal()},showAlert:function(e,t,o){var i='<div id="workflowAlert" class="alert alert-'+o+' alert-dismissible col-md-10 col-md-offset-1"><strong><button type="button" class="close" data-dismiss="alert" ><span>&times;</span></button>'+e+"</strong> "+t+"</div>";$("#alert").html(i)},getBoxes:function(e,t){var d;if(0===(d=t?r.fetchRecords(e):new a).size()){var o=e.get("inventoryItems"),c=e.get("storageType").name;_.each(o,function(e){var t=new h({id:e.id,ref1:e.ref1,ref2:e.ref2,ref3:e.ref3,ref4:e.ref4,ref5:e.ref5,type:e.type,status:e.status});if("BOX"===e.type){var o=new u({id:e.box.id,barcode:e.box.barcode,location:e.box.location,inventoryItem:t});o.storageType=c,d.add(o)}else if("FILE"===e.type){var i=new f({id:e.file.id,barcode:e.file.barcode,location:e.file.location,inventoryItem:t});i.storageType=c;var s=d.findWhere({barcode:e.file.box.barcode});s||((s=new u({id:e.file.box.id,barcode:e.file.box.barcode,location:e.file.box.location,files:new g})).storageType=c,d.add(s)),s.get("files").add(i)}else if("DOCUMENT"===e.type){var n=new m({id:e.document.id,barcode:e.document.barcode,location:e.document.location,inventoryItem:t});n.storageType=c;var r=d.findWhere({barcode:e.document.file.box.barcode});r||((r=new u({id:e.document.file.box.id,barcode:e.document.file.box.barcode,location:e.document.file.box.location,files:new g})).storageType=c,d.add(r));var a=r.get("files").findWhere({barcode:e.document.file.barcode});a||((a=new f({id:e.document.file.id,barcode:e.document.file.barcode,location:e.document.file.location,documents:new p})).storageType=c,r.get("files").add(a)),a.get("documents").add(n)}})}return d}},r=(e=Backbone.Model.extend(),s=new(Backbone.Collection.extend({model:e,localStorage:new Backbone.LocalStorage("in.bigdash.rms.app.storage")})),{storeBox:function(e,t){var o=new u({id:e.get("barcode"),location:e.get("location"),requestId:t.get("id"),storageType:t.get("storageType").name,type:"BOX"});"BOX"===t.get("storageType").name&&o.set({ref1:e.get("inventoryItem").get("ref1"),ref2:e.get("inventoryItem").get("ref2"),ref3:e.get("inventoryItem").get("ref3"),ref4:e.get("inventoryItem").get("ref4"),ref5:e.get("inventoryItem").get("ref5"),type:e.get("inventoryItem").get("type"),status:e.get("inventoryItem").get("status")}),(o=s.add(o,{merge:!0})).save()},storeFile:function(e,t,o){var i=new f({id:e.get("barcode"),location:e.get("location"),parentId:t.get("barcode"),requestId:o.get("id"),storageType:o.get("storageType").name,type:"FILE"});"FILE"===o.get("storageType").name&&i.set({ref1:e.get("inventoryItem").get("ref1"),ref2:e.get("inventoryItem").get("ref2"),ref3:e.get("inventoryItem").get("ref3"),ref4:e.get("inventoryItem").get("ref4"),ref5:e.get("inventoryItem").get("ref5"),type:e.get("inventoryItem").get("type"),status:e.get("inventoryItem").get("status")}),(i=s.add(i,{merge:!0})).save()},storeDocument:function(e,t,o){var i=new m({id:e.get("barcode"),location:e.get("location"),parentId:t.get("barcode"),requestId:o.get("id"),storageType:o.get("storageType").name,type:"DOCUMENT"});"DOCUMENT"===o.get("storageType").name&&i.set({ref1:e.get("inventoryItem").get("ref1"),ref2:e.get("inventoryItem").get("ref2"),ref3:e.get("inventoryItem").get("ref3"),ref4:e.get("inventoryItem").get("ref4"),ref5:e.get("inventoryItem").get("ref5"),type:e.get("inventoryItem").get("type"),status:e.get("inventoryItem").get("status")}),(i=s.add(i,{merge:!0})).save()},remove:function(e){s.get(e.get("barcode")).destroy()},fetchRecords:function(e){s.fetch();var t=s.where({requestId:e.get("id")}),d=new a,c=new g,l=new p;return _.each(t,function(e){var t=e.get("type");if("BOX"===t){var o=new u({barcode:e.get("id"),location:e.get("location")});if(o.storageType=e.get("storageType"),"BOX"===o.storageType){var i=new h({ref1:e.get("ref1"),ref2:e.get("ref2"),ref3:e.get("ref3"),ref4:e.get("ref4"),ref5:e.get("ref5"),type:e.get("type"),status:e.get("status")});o.set("inventoryItem",i)}else o.set("files",new g);d.add(o)}else if("FILE"===t){var s=new f({barcode:e.get("id"),location:e.get("location")});if(s.storageType=e.get("storageType"),s.parentBarcode=e.get("parentId"),"FILE"===s.storageType){var n=new h({ref1:e.get("ref1"),ref2:e.get("ref2"),ref3:e.get("ref3"),ref4:e.get("ref4"),ref5:e.get("ref5"),type:e.get("type"),status:e.get("status")});s.set("inventoryItem",n)}else s.set("documents",new p);c.add(s)}else if("DOCUMENT"===t){var r=new m({barcode:e.get("id"),location:e.get("location")});r.storageType=e.get("storageType"),r.parentBarcode=e.get("parentId");var a=new h({ref1:e.get("ref1"),ref2:e.get("ref2"),ref3:e.get("ref3"),ref4:e.get("ref4"),ref5:e.get("ref5"),type:e.get("type"),status:e.get("status")});r.set("inventoryItem",a),l.add(r)}}),l.each(function(e){c.findWhere({barcode:e.parentBarcode}).get("documents").add(e)}),c.each(function(e){d.findWhere({barcode:e.parentBarcode}).get("files").add(e)}),d},clearRecords:function(e){var t=s.where({requestId:e.get("id")});_.each(t,function(e){e.destroy()})}}),i=Backbone.Model.extend({urlRoot:function(){return this.get("type")?"/api/"+this.get("type").toLowerCase()+"requests":"/api/requests"},initialize:function(){this.listenTo(this,"request",this.requestStart),this.listenTo(this,"sync",this.requestSuccess),this.listenTo(this,"error",this.requestError),this.spinner=new Spinner},startSpinner:function(){this.spinner.spin(document.getElementById("loading"))},stopSpinner:function(e){this.spinner.stop()},requestStart:function(e,t,o){this.startSpinner()},requestSuccess:function(e,t,o){this.stopSpinner()},requestError:function(e,t,o){this.stopSpinner()}}),h=Backbone.Model.extend({defaults:{ref1:"",ref2:"",ref3:"",ref4:"",ref5:"",status:"NOTSTORED",type:null}}),t=Backbone.Collection.extend({model:h}),u=Backbone.Model.extend({defaults:{barcode:"",location:""}}),f=Backbone.Model.extend({defaults:{barcode:"",location:""}}),m=Backbone.Model.extend({defaults:{barcode:"",location:""}}),a=Backbone.Collection.extend({model:u}),g=Backbone.Collection.extend({model:f}),p=Backbone.Collection.extend({model:m}),d=Backbone.Model.extend({defaults:{verified:!1}}),o=Backbone.Collection.extend({model:d}),c=Marionette.View.extend({tagName:"tr",template:"#box-row-template",templateContext:function(){return{storageType:this.model.storageType}}}),l=Mn.View.extend({template:_.template("No Boxes. Start adding boxes.")}),w=Marionette.CollectionView.extend({tagName:"tbody",childView:c,emptyView:l}),v=Marionette.View.extend({template:"#boxes-template",regions:{body:{el:"tbody",replaceElement:!0}},initialize:function(){_.bindAll(this,"handleRecordsSaveSuccess","handleRecordsSaveError","doSaveRecords")},events:{"click #addBoxButton":"addBox","click #deleteBoxButton":"deleteBox","click div.ckbox>input":"updateDeleteButtonEnabled","click #editBoxButton":"editBox","click #showFilesButton":"showFiles","click #saveRecordsButton":"saveRecords","change #boxBarcode":"boxBarcodeChanged","blur #boxBarcode":"focusBack"},focusBack:function(){this.$("#boxBarcode").val(""),this.$("#boxBarcode").focus()},boxBarcodeChanged:function(e){var t=this.$("#boxBarcode").val().toUpperCase().trim();this.$("#boxBarcode").val(""),this.$("#boxBarcode").focus();var o=this.collection.findWhere({barcode:t}),i=this.options.request.get("storageType").name,s=void 0===o;s&&("BOX"===((o=new u({barcode:t})).storageType=i)?o.set("inventoryItem",new h({type:"BOX"})):o.set("files",new g)),"BOX"===i?this.triggerMethod("show:box",o):s&&(this.collection.add(o),r.storeBox(o,this.options.request))},validateRecords:function(){var e=this.options.request.get("storageType").name,o=[];return 0===this.collection.size()&&o.push("No boxes to save"),"BOX"===e||("FILE"===e?this.collection.each(function(e){0===e.get("files").size()&&o.push("Box "+e.get("barcode")+" does not have any files")}):"DOCUMENT"===e&&this.collection.each(function(t){0===t.get("files").size()?o.push("Box "+t.get("barcode")+" does not have any files"):t.get("files").each(function(e){0===e.get("documents").size()&&o.push("Box "+t.get("barcode")+", File "+e.get("barcode")+" does not have any documents")})})),o.length&&(swal.close(),this.showAlert(o,"warning")),0===o.length},showAlert:function(e,t){var o="";1===e.length?o=e[0]:(o="Please check the following: ",_.each(e,function(e){o=o+"<li>"+e+"</li>"})),n.showAlert("Error saving records!",o,t)},saveRecords:function(e){e.preventDefault(),$("#alert").html(""),this.validateRecords()&&swal({title:"Are you sure?",text:"You will not be able to modify records after saving!",type:"warning",showCancelButton:!0,confirmButtonClass:"btn-danger",confirmButtonText:"Yes, Save it!",closeOnConfirm:!1,showLoaderOnConfirm:!0},this.doSaveRecords)},doSaveRecords:function(){var a=new t;this.collection.each(function(r){if(r.get("inventoryItem")){var e=r.clone();e.unset("inventoryItem");var t=r.get("inventoryItem").clone();t.set("box",e),a.add(t)}else r.get("files").each(function(n){if(n.get("inventoryItem")){var e=n.clone(),t=r.clone();e.unset("inventoryItem"),t.unset("files"),e.set("box",t);var o=n.get("inventoryItem").clone();o.set("file",e),a.add(o)}else n.get("documents").each(function(e){var t=e.clone(),o=n.clone(),i=r.clone();t.unset("inventoryItem"),o.unset("documents"),i.unset("files"),o.set("box",i),t.set("file",o);var s=e.get("inventoryItem").clone();s.set("document",t),a.add(s)})})}),this.options.request.save({inventoryItems:a,status:"PACKED"},{wait:!0,success:this.handleRecordsSaveSuccess,error:this.handleRecordsSaveError})},handleRecordsSaveSuccess:function(e,t,o){r.clearRecords(this.options.request),swal({title:"Request Updated!",text:"Records have been saved.",type:"success"},function(){window.location.href="/requests/"+t.id+"/workflow"})},handleRecordsSaveError:function(e,t,o){t.responseJSON.message&&(swal.close(),this.showAlert([t.responseJSON.message],"danger"))},updateDeleteButtonEnabled:function(){$("div.ckbox>input:checked").length?$("#deleteBoxButton").prop("disabled",!1):$("#deleteBoxButton").prop("disabled",!0)},showFiles:function(e){e.preventDefault();var t=String($(e.currentTarget).data("barcode")),o=this.collection.findWhere({barcode:t});this.triggerMethod("show:files",o)},editBox:function(e){e.preventDefault();var t=String($(e.currentTarget).data("barcode")),o=this.collection.findWhere({barcode:t});this.triggerMethod("show:box",o)},addBox:function(e){e.preventDefault();var t=this.options.request.get("storageType").name,o=new u;"BOX"===(o.storageType=t)?o.set("inventoryItem",new h({type:"BOX"})):o.set("files",new g),this.triggerMethod("show:box",o)},deleteBox:function(e){var t=$("div.ckbox>input:checked"),i=[];_.each(t,function(e){var t=String($(e).data("barcode")),o=this.collection.findWhere({barcode:t});o.get("files")&&o.get("files").size()?i.push(o.get("barcode")):(this.collection.remove(o),r.remove(o))},this),0<i.length&&n.showAlert("","Cannot delete non empty records! Skipped boxes: "+i.join(", "),"warning"),this.updateDeleteButtonEnabled()},onRender:function(){this.showChildView("body",new w({collection:this.collection}))},onAttach:function(){this.$("#boxBarcode").focus()}}),b=Marionette.View.extend({template:"#box-template",templateContext:function(){return{storageType:this.model.storageType}},initialize:function(){this.isNewBox=""===this.model.get("barcode")},events:{"click #ok-button":"handleOkButton","click #cancel-button":"handleCancelButton"},validate:function(){this.clearValidationErrors();var e=!0,t=this.$("#barcode").val().trim().toUpperCase(),o=(this.$("#location").val().trim(),this.$("#ref1").val());return t||(this.showValidationError("barcode","may not be empty"),e=!1),"BOX"!==this.options.request.get("storageType").name||o||(this.showValidationError("ref1","may not be empty"),e=!1),e},handleOkButton:function(e){if(e.preventDefault(),this.validate()){var t=this.$("#barcode").val().trim().toUpperCase(),o=this.$("#location").val().trim();if(this.isNewBox&&this.options.boxes.findWhere({barcode:t}))this.showValidationError("barcode","barcode already exists");else{if(this.model.set({barcode:t,location:o}),"BOX"===this.options.request.get("storageType").name){var i=this.model.get("inventoryItem");i.set("ref1",this.$("#ref1").val().trim()),i.set("ref2",this.$("#ref2").val().trim()),i.set("ref3",this.$("#ref3").val().trim()),i.set("ref4",this.$("#ref4").val().trim()),i.set("ref5",this.$("#ref5").val().trim()),this.model.set("inventoryItem",i)}this.showBoxesView()}}},handleCancelButton:function(e){e.preventDefault(),this.model=null,this.showBoxesView()},showBoxesView:function(){this.triggerMethod("show:boxes",this.model,this.isNewBox)},clearValidationErrors:function(){this.$(".form-group").removeClass("has-error has-feedback"),this.$(".help-block").remove()},showValidationError:function(e,t){var o=this.$("#"+e);o.closest(".form-group").addClass("has-error has-feedback"),o.closest("div").append($('<span id="'+e+'-error" class="help-block">'+t+"</span>"))},onAttach:function(){this.isNewBox?this.$("#barcode").focus():(this.$("#barcode").prop("readonly",!0),this.$("#ref1").focus())}}),x=Marionette.View.extend({tagName:"tr",template:"#file-row-template",templateContext:function(){return{storageType:this.model.storageType}}}),B=Mn.View.extend({template:_.template("No Files. Start adding files.")}),y=Marionette.CollectionView.extend({tagName:"tbody",childView:x,emptyView:B}),S=Marionette.View.extend({template:"#files-template",regions:{body:{el:"tbody",replaceElement:!0}},initialize:function(){},events:{"click #addFileButton":"addFile","click #deleteFileButton":"deleteFile","click div.ckbox>input":"updateDeleteButtonEnabled","click #editFileButton":"editFile","click #showDocsButton":"showDocs","click #showBoxesButton":"showBoxes","change #fileBarcode":"fileBarcodeChanged","blur #fileBarcode":"focusBack"},focusBack:function(){this.$("#fileBarcode").val(""),this.$("#fileBarcode").focus()},fileBarcodeChanged:function(e){var t=this.$("#fileBarcode").val().toUpperCase().trim();this.$("#fileBarcode").val(""),this.$("#fileBarcode").focus();var o=this.collection.findWhere({barcode:t}),i=this.options.request.get("storageType").name,s=void 0===o;s&&("FILE"===((o=new f({barcode:t})).storageType=i)?o.set("inventoryItem",new h({type:"FILE"})):o.set("documents",new p)),"FILE"===i?this.triggerMethod("show:file",o,this.options.box):s&&(this.collection.add(o),r.storeFile(o,this.options.box,this.options.request))},showBoxes:function(e){this.triggerMethod("show:boxes")},updateDeleteButtonEnabled:function(){$("div.ckbox>input:checked").length?$("#deleteFileButton").prop("disabled",!1):$("#deleteFileButton").prop("disabled",!0)},showDocs:function(e){e.preventDefault();var t=String($(e.currentTarget).data("barcode")),o=this.collection.findWhere({barcode:t});this.triggerMethod("show:documents",o,this.options.box)},editFile:function(e){e.preventDefault();var t=String($(e.currentTarget).data("barcode")),o=this.collection.findWhere({barcode:t});this.triggerMethod("show:file",o,this.options.box)},addFile:function(e){var t=this.options.request.get("storageType").name,o=new f;"FILE"===(o.storageType=t)?o.set("inventoryItem",new h({type:"FILE"})):o.set("documents",new p),this.triggerMethod("show:file",o,this.options.box)},deleteFile:function(e){var t=$("div.ckbox>input:checked"),i=[];_.each(t,function(e){var t=String($(e).data("barcode")),o=this.collection.findWhere({barcode:t});o.get("documents")&&o.get("documents").size()?i.push(o.get("barcode")):(this.collection.remove(o),r.remove(o))},this),0<i.length&&n.showAlert("","Cannot delete non empty records! Skipped files: "+i.join(", "),"warning"),this.updateDeleteButtonEnabled()},onRender:function(){this.$("#filesPanelTitle").text("BOX "+this.options.box.get("barcode")+" >> FILES"),this.showChildView("body",new y({collection:this.collection}))},onAttach:function(){this.$("#fileBarcode").focus()}}),V=Marionette.View.extend({template:"#file-template",templateContext:function(){return{storageType:this.model.storageType}},initialize:function(){this.isNewFile=""===this.model.get("barcode")},events:{"click #ok-button":"handleOkButton","click #cancel-button":"handleCancelButton"},validate:function(){this.clearValidationErrors();var e=!0,t=this.$("#barcode").val().trim().toUpperCase(),o=(this.$("#location").val().trim(),this.$("#ref1").val());return t||(this.showValidationError("barcode","may not be empty"),e=!1),"FILE"!==this.options.request.get("storageType").name||o||(this.showValidationError("ref1","may not be empty"),e=!1),e},handleOkButton:function(e){if(e.preventDefault(),this.validate()){var t=this.$("#barcode").val().trim().toUpperCase(),o=this.$("#location").val().trim();if(this.isNewFile&&this.options.box.get("files").findWhere({barcode:t}))this.showValidationError("barcode","barcode already exists");else{if(this.model.set({barcode:t,location:o}),"FILE"===this.options.request.get("storageType").name){var i=this.model.get("inventoryItem");i.set("ref1",this.$("#ref1").val().trim()),i.set("ref2",this.$("#ref2").val().trim()),i.set("ref3",this.$("#ref3").val().trim()),i.set("ref4",this.$("#ref4").val().trim()),i.set("ref5",this.$("#ref5").val().trim()),this.model.set("inventoryItem",i)}this.options.box.get("files").add(this.model,{merge:!this.isNewFile}),r.storeFile(this.model,this.options.box,this.options.request),this.triggerMethod("show:files",this.options.box)}}},handleCancelButton:function(e){e.preventDefault(),this.model=null,this.triggerMethod("show:files",this.options.box)},clearValidationErrors:function(){this.$(".form-group").removeClass("has-error has-feedback"),this.$(".help-block").remove()},showValidationError:function(e,t){var o=this.$("#"+e);o.closest(".form-group").addClass("has-error has-feedback"),o.closest("div").append($('<span id="'+e+'-error" class="help-block">'+t+"</span>"))},onAttach:function(){var e=this.options.box.get("barcode"),t=this.isNewFile?"NEW FILE":"FILE "+this.model.get("barcode");this.$("#filePanelTitle").text("BOX "+e+" >> "+t),this.isNewFile?this.$("#barcode").focus():(this.$("#barcode").prop("readonly",!0),this.$("#ref1").focus())}}),E=Marionette.View.extend({tagName:"tr",template:"#document-row-template",templateContext:function(){return{storageType:this.model.storageType}}}),C=Mn.View.extend({template:_.template("No Documents. Start adding documents.")}),I=Marionette.CollectionView.extend({tagName:"tbody",childView:E,emptyView:C}),k=Marionette.View.extend({template:"#documents-template",regions:{body:{el:"tbody",replaceElement:!0}},initialize:function(){},events:{"click #addDocumentButton":"addDocument","click #deleteDocumentButton":"deleteDocument","click div.ckbox>input":"updateDeleteButtonEnabled","click #editDocumentButton":"editDocument","click #showFilesButton":"showFiles","change #docBarcode":"docBarcodeChanged","blur #docBarcode":"focusBack"},focusBack:function(){this.$("#docBarcode").val(""),this.$("#docBarcode").focus()},docBarcodeChanged:function(e){var t=this.$("#docBarcode").val().toUpperCase().trim();this.$("#docBarcode").val(""),this.$("#docBarcode").focus();var o=this.collection.findWhere({barcode:t}),i=this.options.request.get("storageType").name,s=void 0===o;s&&"DOCUMENT"===((o=new m({barcode:t})).storageType=i)&&o.set("inventoryItem",new h({type:"DOCUMENT"})),"DOCUMENT"===i?this.triggerMethod("show:document",o,this.options.file,this.options.box):s&&(this.collection.add(o),r.storeDocument(o,this.options.file,this.options.request))},showFiles:function(e){this.triggerMethod("show:files",this.options.box)},updateDeleteButtonEnabled:function(){$("div.ckbox>input:checked").length?$("#deleteDocumentButton").prop("disabled",!1):$("#deleteDocumentButton").prop("disabled",!0)},editDocument:function(e){e.preventDefault();var t=String($(e.currentTarget).data("barcode")),o=this.collection.findWhere({barcode:t});this.triggerMethod("show:document",o,this.options.file,this.options.box)},addDocument:function(e){var t=this.options.request.get("storageType").name,o=new m;"DOCUMENT"===(o.storageType=t)&&o.set("inventoryItem",new h({type:"DOCUMENT"})),this.triggerMethod("show:document",o,this.options.file,this.options.box)},deleteDocument:function(e){var t=$("div.ckbox>input:checked");_.each(t,function(e){var t=String($(e).data("barcode")),o=this.collection.findWhere({barcode:t});this.collection.remove(o),r.remove(o)},this),this.updateDeleteButtonEnabled()},onRender:function(){var e=this.options.box.get("barcode"),t=this.options.file.get("barcode");this.$("#documentsPanelTitle").text("BOX "+e+" >> FILE "+t+" >> DOCUMENTS"),this.showChildView("body",new I({collection:this.collection}))},onAttach:function(){this.$("#docBarcode").focus()}}),T=Marionette.View.extend({template:"#document-template",templateContext:function(){return{storageType:this.model.storageType}},initialize:function(){this.isNewDocument=""===this.model.get("barcode")},events:{"click #ok-button":"handleOkButton","click #cancel-button":"handleCancelButton"},validate:function(){this.clearValidationErrors();var e=!0,t=this.$("#barcode").val().trim().toUpperCase(),o=(this.$("#location").val().trim(),this.$("#ref1").val());return t||(this.showValidationError("barcode","may not be empty"),e=!1),"DOCUMENT"!==this.options.request.get("storageType").name||o||(this.showValidationError("ref1","may not be empty"),e=!1),e},handleOkButton:function(e){if(e.preventDefault(),this.validate()){var t=this.$("#barcode").val().trim().toUpperCase(),o=this.$("#location").val().trim();if(this.isNewDocument&&this.options.file.get("documents").findWhere({barcode:t}))this.showValidationError("barcode","barcode already exists");else{if(this.model.set({barcode:t,location:o}),"DOCUMENT"===this.options.request.get("storageType").name){var i=this.model.get("inventoryItem");i.set("ref1",this.$("#ref1").val().trim()),i.set("ref2",this.$("#ref2").val().trim()),i.set("ref3",this.$("#ref3").val().trim()),i.set("ref4",this.$("#ref4").val().trim()),i.set("ref5",this.$("#ref5").val().trim()),this.model.set("inventoryItem",i)}this.options.file.get("documents").add(this.model,{merge:!this.isNewDocument}),r.storeDocument(this.model,this.options.file,this.options.request),this.triggerMethod("show:documents",this.options.file,this.options.box)}}},handleCancelButton:function(e){e.preventDefault(),this.model=null,this.triggerMethod("show:documents",this.options.file,this.options.box)},clearValidationErrors:function(){this.$(".form-group").removeClass("has-error has-feedback"),this.$(".help-block").remove()},showValidationError:function(e,t){var o=this.$("#"+e);o.closest(".form-group").addClass("has-error has-feedback"),o.closest("div").append($('<span id="'+e+'-error" class="help-block">'+t+"</span>"))},onAttach:function(){var e=this.options.box.get("barcode"),t=this.options.file.get("barcode"),o=this.isNewDocument?"NEW DOCUMENT":"DOCUMENT "+this.model.get("barcode");this.$("#documentPanelTitle").text("BOX "+e+" >> FILE "+t+" >>  "+o),this.isNewDocument?this.$("#barcode").focus():(this.$("#barcode").prop("readonly",!0),this.$("#ref1").focus())}}),R=Marionette.View.extend({template:"#add-records-template",regions:{body:{el:"#add-records",replaceElement:!0}},initialize:function(){this.boxes=n.getBoxes(this.model,!0)},onRender:function(){this.showBoxesView()},onChildviewShowBox:function(e){this.showChildView("body",new b({model:e,boxes:this.boxes,request:this.model}))},onChildviewShowBoxes:function(e,t){e&&(this.boxes.add(e,{merge:!t}),r.storeBox(e,this.model)),this.showBoxesView()},showBoxesView:function(){this.showChildView("body",new v({collection:this.boxes,request:this.model,rootView:this.options.rootView}))},onChildviewShowFile:function(e,t){this.showChildView("body",new V({model:e,box:t,request:this.model}))},onChildviewShowFiles:function(e){this.showChildView("body",new S({collection:e.get("files"),box:e,request:this.model}))},onChildviewShowDocument:function(e,t,o){this.showChildView("body",new T({model:e,file:t,box:o,request:this.model}))},onChildviewShowDocuments:function(e,t){this.showChildView("body",new k({collection:e.get("documents"),file:e,box:t,request:this.model}))}}),D=Marionette.View.extend({template:"#assign-user-template",initialize:function(){_.bindAll(this,"handleSaveSuccess","handleSaveError")},events:{"click #save-button":"handleSave"},onRender:function(){this.$(".dropdown-select-ajax").select2({debug:!1,theme:"bootstrap",allowClear:!0})},handleSave:function(e){e.preventDefault(),this.$("#userAssigned").val().trim()?this.model.save({userAssigned:{id:this.$("#userAssigned").val().trim()},status:"ASSIGNED"},{wait:!0,success:this.handleSaveSuccess,error:this.handleSaveError}):this.showValidationError("userAssigned","may not be null")},handleSaveSuccess:function(e,t){swal({title:"Request Updated!",text:"User has been assigned successfully.",type:"success"},function(){window.location.href="/requests/"+t.id})},handleSaveError:function(e,t){t.responseJSON&&_.each(t.responseJSON.errors,function(e,t){this.showValidationError(t,e)})},clearValidationErrors:function(){this.$(".form-group").removeClass("has-error has-feedback"),this.$(".help-block").remove()},showValidationError:function(e,t){var o=this.$("#"+e);o.closest(".form-group").addClass("has-error has-feedback"),o.closest("div").append($('<span id="'+e+'-error" class="help-block">'+t+"</span>"))}}),N=Marionette.View.extend({template:"#before-process-request-template",templateContext:function(){return{msg:this.options.msg,title:this.options.title}},initialize:function(){_.bindAll(this,"handleSaveSuccess","handleSaveError")},events:{"click #startProcessRequestButton":"start","click #cancelProcessRequestButton":"cancel"},start:function(e){e.preventDefault(),this.model.save({status:this.options.nextStatus},{wait:!0,success:this.handleSaveSuccess,error:this.handleSaveError})},cancel:function(e){e.preventDefault(),window.location.href="/requests/"},handleSaveSuccess:function(e,t){Backbone.history.navigate(t.id+"/workflow/"+this.options.navText,{trigger:!1}),this.options.nextViewFunction&&this.options.nextViewFunction.apply(this.options.rootView,[this.model])},handleSaveError:function(e,t){t.responseJSON.message&&this.showAlert([t.responseJSON.message],"danger")}}),M=Marionette.View.extend({template:"#view-records-template",regions:{body:{el:"#view-records",replaceElement:!0}},initialize:function(){_.bindAll(this,"handleSaveSuccess","handleSaveError")},events:{"click #startTransitButton":"startTransit"},startTransit:function(e){e.preventDefault(),this.model.save({status:"TRANSIT"},{wait:!0,success:this.handleSaveSuccess,error:this.handleSaveError})},handleSaveSuccess:function(e,t){swal({title:"Request Updated!",text:"Records are now in transit.",type:"success"},function(){window.location.href="/requests/"+t.id})},handleSaveError:function(e,t){t.responseJSON.message&&this.showAlert([t.responseJSON.message],"danger")}}),q=Marionette.View.extend({tagName:"li",className:function(){return"list-group-item list-group-item-"+(this.model.get("verified")?"success":"danger")},template:"#verify-records-row-template",templateContext:function(){return{isSystemBoxesView:this.isSystemBoxesView}},initialize:function(e){this.isSystemBoxesView=e.isSystemBoxesView},triggers:{"click .deleteIncomingBox":"delete:incoming:box"}}),O=Mn.View.extend({template:_.template("No Boxes.")}),A=Marionette.CollectionView.extend({tagName:"ul",className:"list-group boxlist",childView:q,emptyView:O,childViewOptions:function(){return{isSystemBoxesView:this.options.isSystemBoxesView}},onChildviewDeleteIncomingBox:function(e){this.triggerMethod("delete:incoming:box",e.model)}}),F=Marionette.View.extend({template:"#verify-records-template",events:{"change #incomingBoxBarcode":"addIncomingBox","blur #incomingBoxBarcode":"focusBack"},focusBack:function(){this.$("#incomingBoxBarcode").val(""),this.$("#incomingBoxBarcode").focus()},regions:{incomingBoxesRegion:{el:"#incomingBoxesRegion",replaceElement:!0},systemBoxesRegion:{el:"#systemBoxesRegion",replaceElement:!0}},initialize:function(){_.bindAll(this,"handleSaveSuccess","handleSaveError","updateRequest"),this.systemBoxes=new o,_.each(this.model.get("inventoryItems"),function(e){var t=new d({id:e.boxBarcode});this.systemBoxes.add(t)},this),this.incomingBoxes=new o},addIncomingBox:function(e){var t=this.$("#incomingBoxBarcode").val().toUpperCase().trim();if(this.$("#incomingBoxBarcode").val(""),this.$("#incomingBoxBarcode").focus(),console.log(e,t),t){var o=this.systemBoxes.get(t),i=void 0!==o;!0===i&&(o.set("verified",!0),this.systemBoxes.add(o),this.systemBoxes.trigger("reset"));var s=new d({id:t,verified:i});this.incomingBoxes.add(s),this.updateVerifyProgress()}},updateRequest:function(){this.model.save({status:"VALIDATED"},{wait:!0,success:this.handleSaveSuccess,error:this.handleSaveError})},handleSaveSuccess:function(e,t){swal({title:"Request Updated!",text:"Records are now validated.",type:"success"},function(){window.location.href="/requests/"+t.id})},handleSaveError:function(e,t,o){t.responseJSON.message&&(swal.close(),this.showAlert([t.responseJSON.message],"danger"))},updateVerifyProgress:function(){var e=this.systemBoxes.where({verified:!0}),t=this.systemBoxes.size(),o=this.incomingBoxes.where({verified:!0}),i=this.incomingBoxes.size(),s=parseInt(e.length/t*100),n=this.$("#verifyProgressbar");n.width(s+"%"),n.text(s+"%"),e.length===t&&o.length===i&&t===i&&swal({title:"All Records Verified!",text:"",type:"success",closeOnConfirm:!1},this.updateRequest)},onRender:function(){this.updateVerifyProgress(),this.showChildView("incomingBoxesRegion",new A({collection:this.incomingBoxes,isSystemBoxesView:!1})),this.showChildView("systemBoxesRegion",new A({collection:this.systemBoxes,isSystemBoxesView:!0}))},onChildviewDeleteIncomingBox:function(e){var t=e.id;this.incomingBoxes.remove(e);var o=this.systemBoxes.get(t);void 0!==o&&(o.set("verified",!1),this.systemBoxes.trigger("reset")),this.updateVerifyProgress()},onAttach:function(){this.$("#incomingBoxBarcode").focus()}}),U=Marionette.View.extend({tagName:"li",className:"list-group-item list-group-item-info",template:"#store-records-row-template",templateContext:function(){return{isStoredBoxesView:this.isStoredBoxesView}},initialize:function(e){this.isStoredBoxesView=e.isStoredBoxesView},triggers:{"click .deleteStoredBox":"delete:stored:box"}}),L=Mn.View.extend({template:_.template("No Boxes. Start scanning boxes & shelves.")}),P=Marionette.CollectionView.extend({tagName:"ul",className:"list-group boxlist",childView:U,emptyView:L,childViewOptions:function(){return{isStoredBoxesView:this.options.isStoredBoxesView}},onChildviewDeleteStoredBox:function(e){this.triggerMethod("delete:stored:box",e.model)}}),z=Marionette.View.extend({template:"#store-records-template",events:{"change #validatedBoxBarcode":"storeBox"},focusBack:function(){this.$("#validatedBoxBarcode").val(""),this.$("#validatedBoxBarcode").focus()},regions:{validatedBoxesRegion:{el:"#validatedBoxesRegion",replaceElement:!0},storedBoxesRegion:{el:"#storedBoxesRegion",replaceElement:!0}},initialize:function(){_.bindAll(this,"handleSaveSuccess","handleSaveError","updateRequest"),this.validatedBoxes=new a,this.storedBoxes=new a,this.resetLists()},resetLists:function(){this.validatedBoxes.reset(),this.storedBoxes.reset();var t,o=this.model.get("storageType").name;_.each(this.model.get("inventoryItems"),function(e){t=new u("BOX"===o?e.box:"FILE"===o?e.file.box:e.document.file.box),this.validatedBoxes.add(t)},this)},storeBox:function(e){var t=this.$("#validatedBoxBarcode").val().trim().toUpperCase();if(this.$("#validatedBoxBarcode").val(""),t){var o=this.validatedBoxes.findWhere({barcode:t}),i=this;void 0!==o?swal({title:"Scan Shelf Barcode",text:"",type:"input",showCancelButton:!0,closeOnConfirm:1!==this.validatedBoxes.size(),inputPlaceholder:"Shelf Barcode"},function(e){return!1!==e&&(""===e?(swal.showInputError("Scan shelf!"),!1):(o.set("shelf",{barcode:e}),o.set("location",e),i.storedBoxes.add(o),i.validatedBoxes.remove(o),void i.updateStoreProgress()))}):swal({title:"Not a valid box!",text:"Barcode is not part of this request.",type:"error"})}},updateStoreProgress:function(){var e=this.validatedBoxes.size(),t=this.storedBoxes.size(),o=parseInt(t/(e+t)*100),i=this.$("#storeProgressbar");i.width(o+"%"),i.text(o+"%"),0===e&&this.updateRequest()},updateRequest:function(){this.storedBoxes.url="/api/boxes/batch",this.storedBoxes.sync("update",this.storedBoxes,{success:this.handleSaveSuccess,error:this.handleSaveError})},getLocation:function(e){return this.storedBoxes.findWhere({barcode:e}).get("location")},handleSaveSuccess:function(){var t=this.model.get("storageType").name;_.each(this.model.get("inventoryItems"),function(e){e.status="STORED","BOX"===t?e.box.location=this.getLocation(e.box.barcode):"FILE"===t?e.file.location=this.getLocation(e.file.box.barcode):e.document.location=this.getLocation(e.document.file.box.barcode)},this),this.model.save({status:"STORED"},{wait:!0,success:this.handleSaveSuccess2,error:this.handleSaveError2})},handleSaveSuccess2:function(e,t){swal({title:"Request Updated!",text:"Records are now stored.",type:"success"},function(){window.location.href="/requests/"+t.id})},handleSaveError2:function(e,t){t.responseJSON.message&&(swal.close(),n.showAlert([t.responseJSON.message],"danger"))},handleSaveError:function(e){swal.close(),this.resetLists(),this.updateStoreProgress(),e.responseJSON&&e.responseJSON.message?n.showAlert("Error saving boxes",e.responseJSON.message,"danger"):n.showAlert("Error saving boxes",e,"danger")},onChildviewDeleteStoredBox:function(e){this.storedBoxes.remove(e),this.validatedBoxes.add(e),this.updateStoreProgress()},onRender:function(){this.updateStoreProgress(),this.showChildView("validatedBoxesRegion",new P({collection:this.validatedBoxes,isStoredBoxesView:!1})),this.showChildView("storedBoxesRegion",new P({collection:this.storedBoxes,isStoredBoxesView:!0}))},onAttach:function(){this.$("#validatedBoxBarcode").focus()}}),W=Marionette.View.extend({template:"#close-request-template",events:{"click #cancelButton":"cancel"},cancel:function(e){e.preventDefault(),window.location.href="/requests/"}}),X=Marionette.View.extend({template:_.template('<div id="main"></div>'),regions:{main:"#main"},showAssignUserView:function(e){this.showChildView("main",new D({model:e,rootView:this}))},showBeforeProcessRequestView:function(e,t,o,i,s,n){this.showChildView("main",new N({model:e,rootView:this,title:t,msg:o,nextStatus:i,nextViewFunction:s,navText:n}))},showAddRecordsView:function(e){this.showChildView("main",new R({model:e,rootView:this}))},showViewRecordsView:function(e){this.showChildView("main",new M({model:e,rootView:this}))},showVerifyRecordsView:function(e){this.showChildView("main",new F({model:e,rootView:this}))},showStoreRecordsView:function(e){this.showChildView("main",new z({model:e,rootView:this}))},showCloseRequestView:function(e){this.showChildView("main",new W({model:e,rootView:this}))}}),J=Marionette.Object.extend({start:function(e,t){var o=new i({id:e});this.listenToOnce(o,"sync",this.workflow),o.fetch()},workflow:function(e){var t=this.getOption("rootView"),o=e.get("type"),i=e.get("status");"PICKUP"===o&&("OPEN"===i?t.showAssignUserView(e):"ASSIGNED"===i?t.showBeforeProcessRequestView(e,"Add Records","Proceed with adding records to this request?","INPROGRESS",t.showAddRecordsView,"addRecords"):"INPROGRESS"===i?t.showAddRecordsView(e):"PACKED"===i?t.showViewRecordsView(e):"TRANSIT"===i?t.showBeforeProcessRequestView(e,"Verify Records","Proceed with verifying the incoming records for this request?","INCOMING",t.showVerifyRecordsView,"verifyRecords"):"INCOMING"===i?t.showVerifyRecordsView(e):"VALIDATED"===i?t.showStoreRecordsView(e):"STORED"===i?t.showBeforeProcessRequestView(e,"Close Request","Proceed with closing this request?","CLOSED",t.showCloseRequestView,""):"CLOSED"===i&&t.showCloseRequestView(e))}}),G=Marionette.AppRouter.extend({initialize:function(e){this.controller=new J(e)},appRoutes:{":requestId/workflow":"start",":requestId/workflow/*splat":"start"}});(new(Marionette.Application.extend({region:"#app",onStart:function(){var e=new X;new G({rootView:e});this.showView(e),Backbone.history.start({pushState:!0,root:"/requests"})}}))).start()}();